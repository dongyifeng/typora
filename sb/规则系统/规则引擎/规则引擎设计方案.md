---
typora-root-url: ../../../../typora
---

[TOC]

# **一、规则引擎解决什么问题**

社区每天产生大量内容,这些内容的审核需要通过系统的建设能力去识别用户不同维度输入以及行为是否具有风险,给出相应的动作判定,是一种快速审核的重要途径.,这种系统能力就是我们规划策略配置平台的紧迫需求,我们理解的策略配置平台是一种具有根据设定的规则匹配条件触发特定动作的驱动器,使用预定义可视化的语义模块编写业务决策、将繁杂的决策从业务人员不友好的应用程序代码中分离、并在策略调整的时效性上最大程度做到快速调整的能力.归纳了系统建设后所具有的特性.

1. 逻辑与数据的分离,对外只暴露特征(fact)和动作,解耦策略与执行逻辑
2. 策略表达式的高效执行.表达式在编译执行模式下最大程度缩短执行时间
3. 策略调整灵活和高效.易用的配置过程.在策略配置平台将业务直观上能理解的图形化配置翻译成平台引擎能执行的策略条件,实现秒或分钟级别内的策略调整.
4. 完善详细的执行过程,每个步骤都有执行记录和数据快照,便于排查问题和数据校验,为运行期的实时监控也提供了数据支持
5. 知识集中化,平台将流程,规则,特征,策略纳入到管理体系内,构建一个规则知识库,业务人员能自行了解系统的支持能力
6. 抽象所有组件使其具有单一职能,便于任意组合

# **二、原系统存在问题**

通过以上的特性再对比我们原系统存在问题

1. 原系统使用scala构建,所有规则都是硬编码实现
2. 没有统一的日志,排查问题依赖远程debug的方式复现
3. 新老规则同时存在,不同时期的规则叠在一起,规则使的用目的对业务和技术都不是很了解,业务不了解有哪些规则,技术不知道为什么使用这些规则
4. 新规则的上线时间冗长,经过提需求,研发,测试,上线等过程,缺乏应对突发风险的能力

# **三、核心构成**

策略配置平台解决了分支决策的问题,结构上分为两个部分输入(特征,事实),策略与动作输出.决定了我们系统采用正向的数据驱动形式.策略配置平台基于输入的fact进行条件推理,推理后的结果就是0至多个策略被执行

1. 特征

特征为系统运转提供数据来源，作为策略执行的输入(fact对象),比如用户信息,用户行为数据,模型输出.同时也会对输入进行加工,形成新的fact(或者衍生特征).为了便于业务人员我们将特征进行分型分类,每一项特征都是职能单一的,比如用户信息,那就从外部系统加载与用户有关的信息,粉丝数,用户ID,头像,昵称等

1. 策略与动作输出

 策略从定义上又可拆分两个部分,LHS,RHS

LHS即条件部分,条件表达式,用于决定动作是否被执行,

RHS即动作部分,条件表达式执行为true时才会触发动作的执行

![](/images/sb/651d66ce-0ef9-4c70-a145-78342f81bf34.jpeg)



# **四、系统设计**

规则引擎具有支持配置、实时加载、翻译执行的上述模型等能力，规避现有系统特征在策略调整上的繁琐问题，如串并行执行策略的调整、增删特征、特征内参数无法实时调整等问题，目标是尽可能在系统运行时开发人员干预。新系统的交互模型定义如下

![](/images/sb/7ffa932b-4b7e-433b-acd4-df3ce8d43504.png)

上述对交互模型做了约定，总体架构自上而下拆分成多个模块，知识库，实例与外部接口，规则引擎，监控与存储，具体模块划分如下图。

![](/images/sb/fc16c161-d2d7-4bab-b2f3-68030ee71ed0.jpeg)



## **1、知识库**

整个规则涉及到的基础组件纳入到知识库的管理体系，包括特征，特征集，策略，策略集，变量，常量，函数与动作，这些组件将会在不同规则流中复用。不同组件的功能大致如下：



**特征**：如前所述，特征作为策略执行的某一个单项数据员。系统中内置特征自动发现功能，新增的特征会在系统重启自动时加载知识库，当前系统预留了脚本特征，用于特殊情况下的快速发布和功能调整，其它特征一般为研发定制开发的标准特征，每个特征的都有自己的变量输出路径，执行引擎会将所有特征结果填充到策略表达式和动作的运行上下文，当一个特征集上存在相同输出路径时前一个特征结果会被后一个覆盖，如入审的v4接口，其中的所有“规则”输出路径一样，当满足一项规则就退出。如用户信息，帖子信息，用户特定时间内发贴数量，发帖内容命中的关键词表和关键词等。



**特征集**：多个特征组成的集合作为策略条件运行与动作的执行输入。在有时效性要求时可设置当前特征集的为并行执行。

![](/images/sb/f9695c18-59e2-4658-b022-4ec1a9bb3104.jpeg)

**规则**:绑定特征集策略集,作为流程的基本单元,规则流中使用规则来串流程.



**策略**：用于某一项行为做决策控制，支持多个动作，不支持嵌套策略条件与条件外动作（else关键词）。运营人员接触最频繁的一个组件。当策略表达式在运行时所需的变量未提供时，表达式不被触发但会提示缺少相应变量。策略表达式支持多行，最后一行最为输出，表达式内可嵌套函数。



**策略集**：针对一些列的行为做决策控制，支持优先级设置和成功后自动退出设置，当设置为并行运行时优先级无效并且策略集中的每个策略都会触发。当特征集加载或运行完成后触发策略集的执行，但执行引擎不负责策略冲突的检查。以下是一个策略集的伪代码实现：



```java
rule "1.1" ###策略名称
            if
               ${date}>"2021-07-02" &&${type}==1 ###策略条件
            then
                  System.out.println( "1.1 matched" );    ###动作 
                    System.out.println( "1.1 matched" );    ###动作 
end
        
rule "1.2"
            if
                ${date}>"2021-07-01" &&${type}==2&&${list}.contain("rule")
            then
                        System.out.println( "1.2 matched" );            ###动作    
end
        
rule "2.1"
            if
                ${date}>"2021-07-03" && ${type}==4
            then
                        System.out.println( "2.1 matched" );###动作 
               
end
```

**函数：**策略条件的扩展功能，当某些情况下条件表达式过于复杂或无法实现时通过封装的函数可简化表达式，如min，max等。在系统重启时会自动加载函数到知识库。



**变量：**为简化策略的编码难度和规范化特征输出，形成标准特征，将特征的输出抽取成变量（需要在生成特征代码时标记输出参数），以便与未来通过前端拖拽的形式生成策略表达式。



**常量：**系统内置或策略表达式运行时设置的一些不可变变量，如用户性别，发帖频次等，列表和字典类常量会使用json字符串存储，系统初始化时或常量发布时会加载到知识库。与特征输出的变量一样，会填充到策略表达式和动作运行的上下文。



**动作：**策略表达式执行结果为ture时会触发动作的执行，动作具有单一职能的特性，作为标准组件。当某些情况下一个策略表达式会触发多个动作，此时运营人员规划策略时可通过拖拽形式构建。作为标准组件系统重启时新增的动作自动加载到知识库，如常用的动作，用户禁言，用户降权，删帖等，不同动作是隔离的，在规则引擎内可设置为并行执行（现下是串行）





## **2、执行引擎**

系统中所有功能流转都是依据不同的执行引擎控制的，细化功能后拆分为4个单独的子模块，规则流引擎，特征引擎，策略引擎，脚本引擎。

**规则流引擎：**对外提供服务的入口，某一项审核需求会有专用的规则流负责，具有单一职能的特性，下图会展示串行模式下的规则流执行流程，规则流中特征集之间为串行执行(系统设计层面支持也支持并行模式)。

![](/images/sb/a04bc6e3-b9ac-4cb1-948d-48d771fa823b (1).jpeg)

**特征引擎：**管理特征集内所有特征的执行调度，依据不同的需求调整特征的串并模式的调度，特征集当未绑定策略时，相当于直接输出特征结果或为下级特征集绑定的策略集提供输出，现下系统设置了特征结果在规则流引擎中可向下传递。

**策略引擎：**特征引擎聚合的输出作为策略引擎的输入，策略集内的策略都以此输入作为运行的前提准备。

**脚本引擎：**现下集成mvel2作为脚本运行环境与java可以无缝集成，策略表达式即基于mvel2。编译后的脚本执行效率接近java原生代码，**系统预留了扩展其它脚本空间。**



## **3、实例管理**

针对规则流和策略集这俩经常调整的组件，引入规则流实例和策略集实例，来解决安全上下线和生产验证的问题。每个在运行的规则流或策略集都有并且仅有一个已经发布状态的实例，此状态的实例不允许做更改，当有更高需求时，需对已发布状态的实例克隆或复制出新版本，所有的更改都是基于复制后的版本。系统初始化时会加载待发布和已发布的实例，同一个流程只有一个已发布的实例，和最多一个待发布实例。基于此基础上提供了并行和流量控制模式，这两种模式用与验证新实例的准确性。

- 并行模式下，只有已发布的实例才会返回结果，执行策略动作，用于验证两个实例结果的准确性（待完善）
- 流控模式，一般用于小流量验证，此模式下已发布实例和待发布实例都会返回结果和执行策略动作
- 正常模式，只会加载已发布的实例。

**PS:对于流程来说,分为前向配置,后向验证(实例)**



为了实现高效的运行要求，系统内所有资源都会加载导内存中，为此实现了两套allocator,基于内存和MapDb,实例的状态变更或配置变需要很高的实时性，为此需要有一套基于发布订阅模式实时配置加载功能，实现配置自动更新至实例运行环境，此部分功能在系统模型定义时进行初步描述。下图是详细的交互和实现过程。

![](/images/sb/27920cb4-c92c-4398-90cf-b0c055218d78.jpeg)

上述交互过程中实例配置的实时生效时通过状态机维护的，参见下图的实例状态机扭转过程。为了状态机扭转能准确和尽可能的实时使用发布订阅组件的广播机制来实现，如zookeeper等中间件来实现每个服务节点上的配置的“实时”和 准确，

![](/images/sb/f7ff4f5c-1ee3-49e2-9769-5d5512143a79.jpeg)



## **4、监控，存储，实时特征计算**

现有反垃圾系统会记录入审检查后最终的用户或帖子状态，用户和帖子在规则检测过程的中间状态数据没有持久化 ，新规则引擎将会把运行过程会产生的大量不同纬度，不同时间点的数据同步至数仓，如某个时间点用户发贴因命中什么策略而入审，基于此部分数据生成的统计指标能分析用户行为、系统的运行效率，黑产和水军的活动情况等，还可结合一些模型生成实时特征，提升应对不良行为的反应速度。

![](/images/sb/619b179e-29dd-4882-ab02-b2c1da15b501.jpeg)



# **五、待开展的事项**

规则引擎一期已基本完成，接下来就是反垃圾系统适配规则引擎，原则就是尽可能单一职能化每个组件

- 反垃圾系统中的规则适配为特征
- 基于原规则涉及到的用户操作，帖子操作抽象为单一职能的动作
- 适配过程中某些功能抽象为函数
- 特征变量的抽取与管理，为后期版本可视化管理提供支持
- 完善权限体系。如规则的变更，策略中动作的添加需要审核通过才能发布到生产环境
- 环境隔离,RC与生产公用一套配置数据,RC的测试验证会影响生产配置



# **六、未来规划**

后面规则引擎围绕以下几个方面进行开展

1 在前面已经已经提过，规则引擎生产数据和使用数据要形成闭环，基于已有数据经过加工和计算后形成新的实时特征或监控指标

2 基本组件的实时发布功能，，如特征，动作，函数的实时发布。

3 基于语法和词法解析树实现的复杂策略表达能力，如何嵌套if等

4 可视化的策略构建环境