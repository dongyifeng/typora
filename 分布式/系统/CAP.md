---
typora-root-url: ../../../typora
---

[TOC]

# 概述

CAP 原理就好比分布式领域的牛顿定律，它是分布式存储的理论基石。

- C - Consistent，一致性：`all nodes see the same data at the same time`，即所有节点在同一时间的数据完全一致。
- A - Availability，可用性：`Reads and writes always succeed`，即服务在正常响应时间内一直可用。
- P - Partition tolerance，分区容忍性：`the system continues to operate despite arbitrary message loss or failure of part of the system`。即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性或可用性的服务。

<font color=red>**一个分布式系统最多满足其中两项，不可能同时做到这三点。**</font>



<img src="/images/distributed/WX20230206-102040.png" style="zoom: 40%;" />





# Consistency 一致性

`all nodes see the same data at the same time`，即所有节点在同一时间的数据完全一致。

对于一致性，可以分为从客户端和服务端两个不同的视角。

- 从<font color=red>客户端</font>来看，一致性主要指的是多并发访问时更新过的数据如何获取的问题。
- 从<font color=red>服务端</font>来看，则是更新如何复制分布到整个系统，以保证数据最终一致。



一致性的策略：

强一致性：对于关系型数据库，要求更新过的数据，后续的访问都能立即看到，这就是强一致性。

弱一致性：如果能够容忍后续的部分或者全部访问不到，就是弱一致性

最终一致性：如果经过一段时间后，要求能访问到更新的数据，是最终一致性。

CAP 中说的是<font color=red>强一致性</font>



# Availability 可用性

`Reads and writes always succeed`，即服务在正常响应时间内一直可用。

一般衡量一个系统的可用性时，都是使用<font color=red>停机时间</font>来计算的：

| 可用性分类                   | 可用水平（%） | 年可容忍停机时长 |
| ---------------------------- | ------------- | ---------------- |
| 容错可用性                   | 99.9999       | < 1 min          |
| 极高可用性                   | 99.999        | < 5 min          |
| 具有故障自动恢复能力的可用性 | 99.99         | < 53 min         |
| 高可用性                     | 99.9          | < 8.8 h          |
| 商品可用性                   | 99            | < 3.65 d         |

一般说一个系统的可用性达到 5 个 9，意思是：99.999%，全年停机时间不能超过：<font color=red>(1-0.99999)*365\*24\*60=5.236 min</font>



# Partition tolerance 分区容忍性

`the system continues to operate despite arbitrary message loss or failure of part of the system`。即分布式系统在遇到<font color=red>某节点或网络分区故障的时候</font>，<font color=red>集群</font>仍然能够对外提供<font color=red>满足一致性或可用性</font>的服务。

分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求。

简单点说，就是在网络中断，消息丢失的情况下，系统如果还能正常工作，就是有比较好的<font color=red>分区容错性</font>。



# CAP 证明

如下图，网络中有两个节点 N1 和 N2，他们之间网络可以连通，N1 和 N2 分别有一个应用程序（A 和 B）和数据库 V。现在 A 和 B 是分布式系统的两个部分，V 是分布式系统的数据存储的两个子数据库。

在满足一致性的时候，N1 和 N2 中的数据是一样的（V0 == V0），请求无论打到 N1 上还是 N2 上，都会获得同样的数据。

![](/images/distributed/WX20230206-175409.png)

下图是分布式系统正常运转的流程，用户向 N1 机器请求数据更新，程序 A 更行数据库 V0 为 V1，分布式系统将数据进行同步操作 M，将 V1 同步到 N2 中 V0，使得 N2 中的数据更新为 V1，N2 中的数据再响应请求获取 V1 的数据。



![](/images/distributed/WX20230206-195944@2x.png)



作为一个分布式系统，它和单机系统的最大区别，就在于网络。现在假设一种极端情况，<font color=green>N1 和 N2 之间的网络断开了</font>，我们要支持这种网络异常，相当于要满足分区容错性，能不能同时满足一致性和响应性呢？

如下图 N1 和 N2 之间网络断开，用户向 N1 机器请求数据更新，程序 A 更行数据库 V0 为 V1，由于网络断开，所以分布式系统无法将数据进行同步，所以 N2 中的数据依旧是 V0。此时如果用户向 N2 发送读取数据的请求，应用程序没有办立即给用户返回最新的数据 V1，怎么办？

- 第一种选择：<font color=red>牺牲数据一致性，保证可用性。</font>响应旧的数据 V0 给用户。
- 第二种选择：<font color=red>牺牲可用性，保证数据一致性。</font>阻塞等待，直到网络连接恢复，数据更新操作 M 完成之后，再给用户响应最新的数据 V1。



![](/images/distributed/WX20230206-200001@2x.png)





# CAP 权衡



### CA without P

分布式环境下，网络分区是一个自然的事实。因为分区是必然的，所以如果舍弃P，意味着要舍弃分布式系统。无法通过降低 CA 来提升P。要想提升系统的分区容错性，需要通过提升基础设施的稳定性来保障。所以，对于一个分布式系统来说。P 是一个基本要求，CAP三者中，<font color=red>只能在 CA 两者之间做权衡，并且要想尽办法提升 P。</font>



## CP without A

如果一个分布式系统不要求强的可用性，即容许系统停机或者长时间无响应的话，就可以在 CAP 三者中保障 CP 而舍弃 A。

一个保证了 CP 而一个舍弃了 A 的分布式系统，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统。



设计成CP的系统其实也不少，其中最典型的就是很多<font color=red>分布式数据库</font>，他们都是设计成CP的。在发生极端情况时，优先保证数据的强一致性，代价就是舍弃系统的可用性。如Redis、HBase等，还有分布式系统中常用的Zookeeper也是在CAP三者之中选择优先保证CP的。

无论是像Redis、HBase这种分布式存储系统，还是像 Zookeeper这 种分布式协调组件。数据的一致性是他们最最基本的要求。<font color=red>一个连数据一致性都保证不了的分布式存储要他有何用？</font>



## AP wihtout C

要高可用并允许分区，则需放弃一致性。一旦网络问题发生，节点之间可能会失去联系。为了保证高可用，需要在用户访问时可以马上得到返回，则每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。



例如：你在12306买票的时候肯定遇到过这种场景，当你购买的时候提示你是有票的（但是可能实际已经没票了），你也正常的去输入验证码，下单了。但是过了一会系统提示你下单失败，余票不足。这其实就是先在可用性方面保证系统可以正常的服务，然后在数据的一致性方面做了些牺牲，会影响一些用户体验，但是也不至于造成用户流程的严重阻塞。



上面的买票的例子，其实舍弃的只是强一致性。退而求其次保证了最终一致性。也就是说，虽然下单的瞬间，关于车票的库存可能存在数据不一致的情况，但是过了一段时间，还是要保证最终一致性的。



对于多数<font color=red>大型互联网应用</font>的场景，主机众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到 N 个9，即保证 P 和 A ，舍弃C（退而求其次<font color=red>保证最终一致性</font>）。虽然某些地方会影响客户体验，但没达到造成用户流程的严重程度。



## 因地适宜

对于涉及到钱财这样不能有一丝让步的场景，C 必须保证。网络发生故障宁可停止服务，这是保证 CP，舍弃 A。比如前几年支付宝光缆被挖断的事件，在网络出现故障的时候，支付宝就在可用性和数据一致性之间选择了数据一致性，用户感受到的是支付宝系统长时间宕机，但是其实背后是无数的工程师在恢复数据，保证数数据的一致性。



对于其他场景，比较普遍的做法是选择可用性和分区容错性，舍弃强一致性，退而求其次使用最终一致性来保证数据的安全。这其实是分布式领域的另外一个理论——BASE理论。我们下一篇文章再来介绍。
