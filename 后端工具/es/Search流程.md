[TOC]

# Search 流程

GET 流程是通过 _index、_type、_id 三元组来确定唯一文档，但是 search 流程不知道要查询哪些文档。

Search 流程分为两个过程

1. Query（检索）
2. Fetch（获取）



Search 流程的主要步骤

1. 遍历所有分片，发送 Query 请求
2. 协调节点合并检索结果
3. 根据 ID 获取文档内容。

例如：有 5 分片，返回前 10 个匹配度最高的文档，每个分片都检索出当前分片的 TOP 10，协调节点将 5 * 10 = 50 个结果再次排序，返回客户端最终的 TOP 10 的结果查询。



## Query 阶段

一个搜索请求必须询问索引的所有分片的某个副本来进行匹配。

比如：一个索引有 5 个主分片，每个主分片有 1 个副分片，共 10 个分片，一次搜索会请求 5 个分片来共同完成。它们可能是主分片，也可能是副分片。

![](images/screenshot-20211121-204742.png)



## Fetch 阶段

![](images/screenshot-20211121-204843.png)