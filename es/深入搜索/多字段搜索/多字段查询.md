# 多字段查询

使用 bool 查询组合起来

```apl
GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { "title":  "War and Peace" }},
        { "match": { "author": "Leo Tolstoy"   }}
      ]
    }
  }
}
```



<font color=red>bool 查询采用 more-matches-is-better 匹配越多越好的方式。每条 match 语句的评分结果被加在一起，从而为每个文档提供最终得分：_score。</font>

能与两条语句同时匹配的文档比只与一条语句匹配的文档得分要高。



作者要比译者更高的权重

```apl
GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": { "title":  "War and Peace" }},  							# s1
        { "match": { "author": "Leo Tolstoy"   }},  							# s2
        { "bool":  {
          "should": [
            { "match": { "translator": "Constance Garnett" }},		# s3
            { "match": { "translator": "Louise Maude"      }}			# s4
          ]
        }}
      ]
    }
  }
}
```

为什么要将译者的条件语句放入另一个独立的 bool 查询？而不是将 translator 语句与 title ，author 放在同一层？

答案在于评分的计算方式。`bool` 查询运行每个 `match` 查询，再把评分加在一起，然后将结果与所有匹配的语句数量相乘，最后除以所有的语句数量。处于同一层的每条语句具有相同的权重。例子中，包含 translator 语句的 `bool` 查询，只占总评分的三分之一。如果将 translator 语句与 title 和 author 两条语句放入同一层，那么 title 和 author 语句只贡献四分之一评分。



如果命中 s1 和 s3 那么  $\_score=\frac{2*(\frac{s3}{2})}{3}$



## 语句优先级



使用 boost 更灵活的调权。

```apl
GET /_search
{
  "query": {
    "bool": {
      "should": [
        { "match": {                    # 1
            "title":  {
              "query": "War and Peace",
              "boost": 2
        }}},
        { "match": { 									 # 1
            "author":  {
              "query": "Leo Tolstoy",
              "boost": 2
        }}},
        { "bool":  { 								  # 2
            "should": [
              { "match": { "translator": "Constance Garnett" }},
              { "match": { "translator": "Louise Maude"      }}
            ]
        }}
      ]
    }
  }
}
```

1. Title 和 author 语句的 boost 值为 2
2. 嵌套 bool 语句默认的 boost 值为 1

要获取 `boost` 参数 “最佳” 值，较为简单的方式就是不断试错。

<font color=red>`boost` 值比较合理的区间处于 `1` 到 `10` 之间</font>，当然也有可能是 `15。如果为 `boost` 指定比这更高的值，将不会对最终的评分结果产生更大影响，因为评分是被 [归一化的（normalized）](https://www.elastic.co/guide/cn/elasticsearch/guide/current/_boosting_query_clauses.html#boost-normalization) 。

