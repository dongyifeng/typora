---
typora-root-url: ../../../../typora
---

审核规则引擎配置平台（三期）

[TOC]

# 一、修订记录

## 1、背景与现状

审核配置平台二期功能已上线，业务提出了部分优化功能需求，且系统数据需求未实现。

## 2、需求要点&目标

- **⚠️：**文档内容仅包含三期部分，请仔细阅读！！！～～～
- 粉色为不在本期实现的需求
- 蓝色为待确认需求
- 绿色为重点内容
- 紫色为改动点

## 3、相关系统

审核系统-规则引擎、前后端

# 二、需求描述

## 1、三期需求内容

- 业务优化需求（详见下方）
- 数据落仓:mysql和kafka数据推送，解析落库，再从数仓查询。（jira:暂时无法在文档外展示此内容)
- 操作日志（前后端、前端操作日志记录需要提供表字段）
- 模型迁移

### 1.1 业务优化需求

业务优化需求涉及前后端，尽量前端需求集中前置，后端需求后置，但前端涉及的改动点后端也可能同步改动。

#### 1.1.1 文案优化

- 知识库管理-策略集管理-处罚动作配置

| **现文案**                                            | **调整后文案**                          |
| ----------------------------------------------------- | --------------------------------------- |
| - 用户是否降权 - 禁发动作 - 处理白名单规则 - 入审动作 | 用户发文全量降权 - 禁发 - 白名单 - 入审 |

![](/images/sb/9171f047-f3cd-4e0a-a5dc-33016b39972b.png)





- 知识库管理-策略集管理-策略配置、特征管理-特征配置中都要修改

| **模块**                     | **现文案**                               | **调整后文案**     |
| ---------------------------- | ---------------------------------------- | ------------------ |
| 模板                         | 例如：是否命中XXX                        | 改为：命中XXX      |
| 特征配置-特征属性字段        | 标记是否为雪球7*24账号                   | 标记为雪球7*24账号 |
| 是否大V账号                  | 命中大V账号                              |                    |
| 是否屏蔽用户                 | 命中屏蔽用户                             |                    |
| 策略集管理-策略配置-特征属性 | 同上特征属性的修改，枚举同步调整后的文案 |                    |

![](/images/sb/baccf4df-7d6f-4600-963f-e9dc04de5bb7.png)

![](/images/sb/f050b6d5-fab3-4043-be5d-6299e38f5bef.png)



![](/images/sb/3740473b-e145-4178-b5d7-5c81bdd07de5.png)





- 知识库管理-策略集管理-策略集配置-新增策略集、规则列表-规则流单元配置的新增和编辑弹窗内都改：（这个逻辑中是否的枚举逻辑也要相应修改，详见下方功能需求描述）

| **现字段文案**     | **调整后文案**         |
| ------------------ | ---------------------- |
| 执行成功后是否退出 | 命中后是否执行后续策略 |

![](/images/sb/e37c9169-f8f3-4a78-9029-e4785ed26117.png)



![](/images/sb/afeeb6b0-80ed-4d56-826e-9d0756258d17.png)





- 流程引擎配置-规则流列表

| **现字段文案** | **调整后文案** |
| -------------- | -------------- |
| 规则集id       | 特征集id       |

![](/images/sb/5a82378e-a69c-4260-91d2-fad21d007a9d.png)



- 流程引擎配置-规则流列表-规则集id-【查看】按钮弹窗

| **现字段文案** | **调整后文案** |
| -------------- | -------------- |
| 包含规则       | 包含特征       |

![](/images/sb/07eabd5a-72be-452a-b4ab-cc189394b23b.png)



#### 1.1.2 基础功能需求

##### 1.1.2.1 动作新增 （0520）

- 以下列表新增动作，需要展示在【处罚动作列表】中，并且【策略配置】的【动作】选择枚举需要展示新增的枚举选项。

- PS：

  （以下标绿前端不用看）

  - 以下置灰动作的新增相当于从审核后台原词表或者其他策略及其产生的动作迁移到配置中心，需要与审核后台共同完成最终的迁移，三期阶段可以新增这些动作，但上线后业务不配置，保证审核后台对于这些动作的策略正常运行，不对审核后台已有词表策略和动作造成影响。
  - 后续需要把词表相关策略一并迁移到审核后台，目前帖子评论已完成可配置操作，IM等其他生效场景需要再沟通是否能迁移和其方式。
  - 若确定方案后，审核后台需将词表以下动作和相关策略移除，所有策略从配置中心配置生效即可。

| **动作名称**                   | **动作生效场景**              | **生效环节** | **是否本期新增** | **备注****（前端动作列表调后端接口则无需前端改动）**         |
| ------------------------------ | ----------------------------- | ------------ | ---------------- | ------------------------------------------------------------ |
| 免审（豁免）                   | 帖子/评论/昵称/简介/话题/图片 | 事后         | 是               | 命中后不执行策略直接退出                                     |
| 屏蔽(自见)                     | IM/评论                       | 事前         | 是               | 优先级高，做评论，不做IM                                     |
| 进审-先审后发 （待审屏蔽）     | 帖子/评论                     | 事后         | 是               | 需要规则引擎支持策略匹配审核区？还是目前动作可以写死传入人审。  直接在目前的先审等动作上修改名称即可，同步到前端列表修改。 |
| 进审-先发后审 （待审全局降权） | 帖子                          | 事后         | 是               | 同上                                                         |
| 进审-先发后审 （待审可见）     | 评论                          | 事后         | 是               | 同上                                                         |
| 评论预定审核-先发后审          | 帖子                          | 事后         | 是               | 需要进评论预定审核区（默认都是先审，名字后缀不重要）         |
| 评论预定审核 -先审后发         | 帖子                          | 事后         | 是               | 需要进评论预定审核区（默认都是先审，名字后缀不重要）         |
| 评论连带主帖进审               | 评论                          | 事后         | 是               | 因为评论把帖子带入先审后发审核区                             |
| 进审-用户状态复核              | 帖子                          | 事后         | 是               | 优先级高                                                     |
| 进审-用户预审                  | 用户                          | 事后         | 是               |                                                              |
| 禁搜                           | 搜索                          | 事前         | 否               | 新流程，无实际审核，动作上线直接推搜索服务。                 |
| 删除                           | 帖子/评论/昵称/简介/话题/图片 | 事后         | ？               | 删除简介是新流程，无实际审核，动作上线直接推UC。             |
| 禁止评论                       | 帖子                          | 事后         | 否               | 新流程，无实际审核，动作上线直接推帖子。                     |
| 禁止转发                       | 帖子/评论                     | 事后         | 否               | 新流程，无实际审核，动作上线直接推帖子。                     |
|                                |                               |              |                  |                                                              |

##### 1.1.2.2  特征配置

- 知识库管理-特征管理-特征配置
  - 增加一列数据，表头字段为【返回值】，该数据为静态信息，即特征参与策略后可能出现的动作，若原系统中业务没有提供，表中也没有返回值描述，则直接按照策略配置中关联的动作进行联动展示。有更新的时候需要同步更新。
  - 前端实现以弹窗形式展示。

![](/images/sb/60a9fe72-ede9-4499-9734-c6363df25d0c.png)



##### 1.1.2.3 搜索功能

- 策略新增、编辑配置中的下拉列表框支持输入全搜索和sug搜索查询，策略配置中的动作和特征选择枚举太多，不便于操作。

![](/images/sb/d5b94dbb-a9d7-4bf2-b620-25a6fb0033d0.png)



##### 1.1.2.4 枚举逻辑对掉

- 知识库管理-策略集管理-策略集配置-新增策略集、规则列表-规则流单元配置的新增和编辑弹窗内的【执行成功后是否退出】字段，由于字段名称需要修改为【命中后是否执行后续策略】，则枚举【是/否】的逻辑需要对掉。

![](/images/sb/9846f899-4917-4f0d-b9d0-a2616ad89240.png)



##### 1.1.2.5列表字段

知识库管理-策略集管理-策略集配置、流程引擎配置-规则流列表，增加【发布时间】列，后端该列统计值为最近一次发布的策略对应的时间。

![](/images/sb/1eb8200b-c63c-406a-9031-283fbe581f2f.png)

![](/images/sb/ce16a951-c152-4dcf-94aa-260bdd4800f5.png)



#### 1.1.3 业务待确认需求（不做）

![img](https://xueqiu.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjZiNWFkZTcxOTJiNDVlNTlhN2JmYWU2ZmY4ZjBiMjdfd1pZOWJkMGVvVWVYb0M4WlBsVUYwVGhqZlJKems4aUxfVG9rZW46Ym94Y24wMjAzaWtDM0w5MEx2SGJRcDhDc1FlXzE2NjkxNzE2MjY6MTY2OTE3NTIyNl9WNA)

### 1.2  策略迁移及策略配置功能优化

#### 1.2.1 策略迁移（无前端）

- 待沟通：以下策略为业务整理目前未在策略配置平台展示的策略，需要逐一判断是否为现有人审策略，还是机审策略写死不好迁移、复杂无法拆分，或新策略增加。

| 序号 | 原因                                             |
| ---- | ------------------------------------------------ |
| 1    | ✅                                                |
| 2    | 延期，帖子相关                                   |
| 3    | 延期，帖子相关                                   |
| 4    | 延期，全审开关目前已有，暂不考虑移动到平台页面。 |
| 5    | 延期，在帖子维护                                 |
| 6    | 延期，在帖子维护                                 |

![img](https://xueqiu.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWRiOTAyNWIzYzNjNjBmN2MzOTA2OTVhYzNiYmU1Mjdfc0I5UU43WXlRTDk5SHBxdkFzelVPYVU3R1ZqSWRVakVfVG9rZW46Ym94Y245U3FlM2tOajVpdHI4ODdUZDlCUWhmXzE2NjkxNzE2MjY6MTY2OTE3NTIyNl9WNA)

#### 1.2.2 策略拆分（无前端）

前期策略未拆分为现有结构的，需要继续拆分。

#### 1.2.3 复杂策略配置（待确认是否本期修改配置）

- 支持现有审核区的配置？-延期
- 支持复杂策略：规则关联免审策略的，需要日志标记为免审。（后端）

### 1.3 数据需求（有前端）

#### 1.3.1 数据落仓

- 数仓建表，解析数据存储并可供查询，与数仓沟通表结构、解析方式和字段。
- jira:（jira:无法复制加载中的内容)
- 包含但不限于业务需求落表字段：[策略配置数据落表字段](https://xueqiu.feishu.cn/wiki/wikcnvZx8XcwjrnT2n7XNURRaZf?sheet=XeZhc6) 

#### 1.3.2 操作日志

- 操作日志维度：按操作模块区分，颗粒度细化到各个模块可配置的功能按钮上。
- 模块枚举：（冒号前是枚举值，冒号后是颗粒度）
  - 特征管理-特征集配置：新增、编辑、启停装置、选择特征
  - 特征管理-特征配置：启禁用装置
  - 模型特征管理：模版新增、模型特征操作
  - 策略集管理-策略配置：策略新增、策略编辑、启停装置
  - 策略集管理-处罚动作配置：动作场景选择、保存、启停装置
  - 策略集管理-策略集配置：新增、编辑、复制
  - 流程引擎配置-策略集实例接口列表：实例状态改变、分流操作
  - 流程引擎配置-规则列表：新增、编辑
  - 流程引擎配置-规则流列表：编辑、复制、启禁用装置
  - 流程引擎配置-实例接口列表：实例状态改变、分流操作

![](/images/sb/cdc1a035-7fec-46dd-9b28-b259c5a6eb46.png)



#### 1.3.3 数据同步（无前端）

- 业务需求：引擎中的审核数据和命中的策略需要在审核后台库落snowflake_censor.content_audit表，规则引擎同步数据到审核后台（具体方式开发定），接口出入参数需要但不仅限于如下字段：

| **字段名** | **详情** | **备注** |
| ---------- | -------- | -------- |
| 规则id     |          |          |
| 策略集id   |          |          |
| 详情list   | 策略id   |          |
|            | 策略名称 |          |

- [规则id对应规则说明](https://xueqiu.feishu.cn/wiki/wikcn9Qw06r3m2yRVLLGAiim0gb)

#### 1.3.4 可视化数据（有前端）

- 数据统审-数据指标统计菜单下增加子菜单/多个页签：总量统计表、策略统计表、策略命中详情表

![](/images/sb/037ab219-ac42-49d1-a332-0c4a2e7c941a.png)



- 由于业务最终需求为规则引擎库和审核后台库跨库查询，跨库统计数据，综合计算策略命中全流程的数据量，但该需求实现时间较长，本期先实现策略配置中心个库查询即可。
  - 总量统计表：

![](/images/sb/5425aa39-42e9-479b-99c0-3c2cb9c6030e.png)



- 策略统计表

![](/images/sb/45da76c0-24c6-46be-b0d6-bfa64a66d4a4.png)



- 策略命中详情表

![](/images/sb/821425af-bfa0-41a7-a96c-d4b8062b6595.png)







# 三、补充需求

## 1、需求内容

### 1.1 功能需求

- 知识库-特征管理-特征配置-特征返回值增加增删改功能
  - 新增返回值：点击查询返回值，弹窗内增加【新增】功能，点击新增后，双重弹窗（交互避免太过复杂，美观度可暂不care）。id系统自动生成，name支持手写输入，code支持手写输入type可选，全部必填。
  - 编辑返回值：编辑与新增一直，id代入，其他字段可修改，保存提交后更新即可。
  - 删除返回值：返回值可直接删除

![](/images/sb/376ba173-0d27-4dd1-891b-b43a9f870f2d.png)



![](/images/sb/7650669c-6c1c-43d4-b70b-a726e5df0593.png)





- 规则列表增加【id】列

![](/images/sb/04af62bf-6bf9-43f7-8529-b2a2c890a1f5.jpeg)



- 规则列表-规则流单元配置-策略集实例列表表头增加【策略集实例code属性】列

![](/images/sb/092f74ee-8a08-4c1e-a867-ec2751e3d23f.jpeg)

