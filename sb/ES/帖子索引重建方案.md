帖子索引重建方案



# 一、需求

需要在帖子索引里面添加帖子标题、正文前100个字段、nlp相关性分数等字段。



# 二、计划

当前线上已经基于“统一分词”需求重建过一次索引“status_exp”，已经有相关技术沉淀。

为了方便后续再有类似修改索引相关需求，调研过索引拆分的技术方案[帖子索引拆分方案](https://xueqiu.feishu.cn/wiki/wikcnskIrKzTaU2RAa0xRxsDxmE) 

可以更灵活的支持索引调整的小流量实验

所以此次索引重建需求以拆分索引为主



# 三、步骤

1. 在RC环境进行测试拆分[帖子索引拆分实践（RC）](https://xueqiu.feishu.cn/wiki/wikcnovBhSK3hPSLAwtDuQ1EG28) 
2. 创建以时间为后缀的帖子索引和backup索引，并指定别名
3. index项目双写，新索引数据根据createdAt插入到指定索引，插入失败的插入到backup索引
4. 根据createdAt全量重刷历史帖子数据
5. sort项目修改帖子返回数据格式（目前只返回了帖子id，需返回rank所需要的特征字段）
6. sort项目添加实验逻辑
7. 实验平台配置相关实验参数（实验索引名等）



# 四、实验功能点

1. 索引拆分之后的查询效果（包括返回结果和查询性能）
2. 帖子标题、正文前100个字段等特征排序实验



特征排序实验依赖于索引拆分之后的查询效果，如果查询效果不理想，按照重建“status_exp”索引的步骤，重建一个单独的大索引；如果查询效果没问题，后续逐步将status_v7索引流量迁移至拆分之后的新索引。



# 五、问题

1、现在帖子搜索线上流量还有97%走的是原始搜索逻辑，即query调用sort召回会根据count参数返回指定条数的帖子（sort里面做的分页，query只能拿到少量数据），并不能很好的支持rank模块。而新多路召回逻辑目前线上流量只有3%。



解决方案1：新多路召回逻辑切流

问题：目前线上NLP股票相关性过滤效果还在评估中，之前短期数据评估并没有一个稳定的效果提升



解决方案2：新索引实验需要依赖新多路召回的实验配置，即同层同召回策略，只不过需要添加特定参数（参考title调权实验149）

问题：会有实验数据冗余，后续调整要调整多个实验配置，实验效果对比容易混乱的问题





2、索引命名问题，假如实验效果很好，怎么将实验索引切换为全量查询的索引

- status_2010_v1、status_2011_v1、status_2012_v1。。。status_2022_v1
- status_2010_v2、status_2011_v2、status_2012_v2。。。status_2022_v2
- status_2010_v3、status_2011_v3、status_2012_v3。。。status_2022_v3

。。。



3、全量重刷数据的机制

- 固定周期去刷全量索引
- 实验效果好，就直接在周末刷



# 六、附录

#### 1、创建索引命令

```Java
PUT status_v1_2022

{

    "aliases" : { 

      "status_v1_exp":{}

    },

    "mappings" : {

      "_doc" : {

        "dynamic" : "strict",

        "_all" : {

          "enabled" : false

        },

        "properties" : {

          "allSymbols" : {

            "type" : "keyword"

          },

          "allSymbolsCharLength" : {

            "type" : "short"

          },

          "allSymbolsSize" : {

            "type" : "short"

          },

          "antiSpamState" : {

            "type" : "integer"

          },

          "content" : {

            "type" : "text",

            "analyzer" : "whitespace"

          },

          "contentLength" : {

            "type" : "integer"

          },

          "createdAt" : {

            "type" : "long"

          },

          "data" : {

            "type" : "text"

          },

          "favCount" : {

            "type" : "integer"

          },

          "flags" : {

            "type" : "keyword"

          },

          "followerCount" : {

            "type" : "integer"

          },

          "goodReplyCount" : {

            "type" : "integer"

          },

          "likeCount" : {

            "type" : "integer"

          },

          "nlpRelevance" : {

            "type" : "double"

          },

          "replyCount" : {

            "type" : "integer"

          },

          "replyUserCount" : {

            "type" : "integer"

          },

          "retweetCount" : {

            "type" : "integer"

          },

          "retweetStatusId" : {

            "type" : "long"

          },

          "rewardMoney" : {

            "type" : "integer"

          },

          "rewardUserCount" : {

            "type" : "integer"

          },

          "sameStatusId" : {

            "type" : "long"

          },

          "simHashValue" : {

            "type" : "long"

          },

          "source" : {

            "type" : "keyword"

          },

          "staticScore" : {

            "type" : "double"

          },

          "statusId" : {

            "type" : "long"

          },

          "symbolAccessOrder" : {

            "type" : "integer"

          },

          "symbols" : {

            "type" : "keyword"

          },

          "tags" : {

            "type" : "keyword"

          },

          "textHash" : {

            "type" : "keyword"

          },

          "textSimHashGroup" : {

            "type" : "keyword"

          },

          "title" : {

            "type" : "text",

            "analyzer" : "whitespace"

          },

          "titleSymbols" : {

            "type" : "keyword"

          },

          "userId" : {

            "type" : "long"

          },

          "nlpCategory" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

          "nlpStaticScore" : {

            "type" : "double"

          },

          "nlpSymbols" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

          "nlpTopic" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

           "textQuality" : {

            "type" : "double"

          },

           "summary" : {

            "type" : "keyword"

          },

           "categoryV2" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

           "titleStockCorrelation" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

          "descStockCorrelation" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

          "contentStockCorrelation" : {

            "type" : "nested",

            "properties" : {

              "name" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

          "keywordNlp" : {

            "type" : "nested",

            "properties" : {

              "keyword" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

           "keywordNlpTitle" : {

            "type" : "nested",

            "properties" : {

              "keyword" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

           "keywordNlpDesc" : {

            "type" : "nested",

            "properties" : {

              "keyword" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          },

           "keywordNlpContent" : {

            "type" : "nested",

            "properties" : {

              "keyword" : {

                "type" : "keyword"

              },

              "score" : {

                "type" : "double"

              }

            }

          }

        }

      }

    },

    "settings" : {

      "index" : {

        "number_of_shards" : "5",

        "number_of_replicas" : "1"

        }

    }

}
```

标黄为此次新增字段