---
typora-root-url: ../../../../typora
---

[TOC]

# **一、实现目标**

1、尽可能缩程流程时间,异步方式推送日志

2、不干扰主流程,kafka生产者异常仍可以最大可能保证数据不丢失和流程正常

3、提高数据推送效率,硬盘+内存的store模式,充分利用本地硬盘的容量和内存的高效特性

4、引擎运转的记录都是可追溯的,基于日志数据所能完成的统计分析

# **二、交互过程**

引擎执行单元有4个组件组成流程执行器,规则执行器,策略集执行器,策略执行器,每个组件执行过程都会产生相应交互数据.这些数据可以反向还原执行过程.因此可以非常便捷定位用户个体或单条内容维度的问题.在运营人员做数据分析时也有了数据支持.为了适配这两个需求,数据流向上也分为两个ambai集群和数仓.日志数据的存储拆分成索引+数据的结构.索引由覆盖常用的查询条件字段组成.数据部分由rowkey(contextId)+数据体构成.系统在设计时引入了上下文的概念,流程执行时存入流程上下文,策略执行过程中也上下文.上下文将流程到策略再到动作串联出来.一个上下文ID可以查询出一次用户交互内在系统内所有存在的数据.下图即为执行过程需要埋点日志的地方

![](/images/sb/55d9f404-1cb4-43ca-8a39-1b223c2784e4.jpeg)

根据引擎各个组件的交互过程,将日志拆分成5类

1. 流程日志

记录请求触发的流程经过,包含流程各个配置参数,如流程模式,流量比例,当前加载的规则列表等,并且将用户,发帖等信息关联到流程上.对于并行模式的流程实例,从原来的上线文中复制出新的上下文.

1. 规则日志

规则列表在执行过程中,可能因某些规则被命中而退出流程,在此日志中记录规则的命中过程.

1. 特征日志

特征日志是所有日志最复杂的一块,难点就是经常变动,套层级可能较多,在数据分析时可能需要数仓进行打平

1. 策略集日志

用户请求在触发某个规则后,记录策略集配置参数并且复制并行模式下的策略上下文

1. 策略与动作日志

记录根据特征做出的决策结果(boolean)和触发的动作,以及动作成功状态与结果



### **1、面向单体数据查询**

如前所述,为了便于查询用户交互过程,在本地服务端设有索引表,数据部分提交至ambari,使用索引表能覆盖的查询条件反查rowkey(contextId),再查询所有能关联的流程,规则、策略等执行过程日志,使用mysql(mongodb)作为存储介质

### **2、面向分析**

此部分数据会拆分为两部分.静态配置与交互的流程、规则、策略等执行过程日志.

- 静态数据,流程、规则、策略等配置数据.
- 引擎运转数据、规则、策略等执行过程日志 ,还有在本地服务数据表中的索引.

### **3、数据推送**

![](/images/sb/69c58f86-fa9d-4565-abef-06390c62b37f.jpeg)



- 为进一步减少流程不必要的执行时间,引入本地store作为临时存储,进行异步推送
- 资源同步器异步拉取数据,保存实体数据与索引
- 正常情况下使用多个消费者推送消息,进一步释放主流程
- 推送异常进程重新进入本地队列再异步直推kafka

### **4、队列**

- 硬盘store的自动缩容与扩容,支持初始大小与增长因子设置
- 内存+硬盘的模式,效率与容量的提升,内存为主硬盘为辅,callback机制依赖硬盘队列
- 减小数据体积,lz4与snappy
- callback确保数据被正确推送,支持推送次数限制

![](/images/sb/7a59ed5e-cbcd-49de-9704-a57891c91846.jpeg)



# **三、格式定义**

- 不同的rowkey定义有差异
- env是为了区分生成环境和离线跑批
- 表格中红色标记的索引属性,索引从日志实体数据内抽去的,目前暂是这些属性
- contextId  有序且为数值型,保正式数据插入的高效

### **1、 实例索引**

#### **1.1 流程实例日志与索引**

| rowKey       | contextId       |        |                                              |
| ------------ | --------------- | ------ | -------------------------------------------- |
| 属性名称     | 属性            | 类型   | 备注                                         |
| 环境         | evn             | string | 标识当前数据来自与哪个数据                   |
| ID/rowKey    | rowKey          | string | 本条记录的唯一ID                             |
| 数据类别     | category        | string | 数据类别,参见数据类别枚举                    |
| 创建时间     | createTime      | long   |                                              |
| 上下文Id     | contextId       | string | 请求标识ID                                   |
| 流程实例id   | flowInstanceId  | long   |                                              |
| 流程id       | flowId          | long   |                                              |
| 流程编码     | flowCode        | string |                                              |
| 分流比例     | scale           | int    |                                              |
| 执行模式     | mode            | int    |                                              |
| 父级上下文id | parentContextId | string |                                              |
| 业务交互ID   | contentId       | string | 与业务交互时,将业务方传递的id转换为contentId |
| 用户ID       | userId          | long   |                                              |
| 备用         | spare           | string | 备用属性,暂时为空                            |
| 数据类型     | contentType     | string | 数据类型 帖子，评论 ，图片等                 |
| 规则列表     | nodes           | string | 规则ID列表,逗号分隔                          |
| 流程响应码   | code            | string | 标记流程的执行状态                           |

#### **1.2 策略实例日志与索引**

| rowKey         | (rowkey:strategyContextId+nodeId+strategySetInstanceId+strategySetId |        |                                  |
| -------------- | ------------------------------------------------------------ | ------ | -------------------------------- |
| 属性名称       | 属性                                                         | 类型   | 备注                             |
| 环境           | evn                                                          | string | 标识当前数据来自与哪个数据       |
| ID/rowKey      | rowKey                                                       | string | 本条记录的唯一ID                 |
| 数据类别       | category                                                     | string | 数据类别,参见数据类别枚举        |
| 创建时间       | createTime                                                   | long   |                                  |
| 上下文Id       | contextId                                                    | string | 请求标识ID                       |
| 流程ID         | flowId                                                       | long   |                                  |
| 流程实例ID     | flowInstanceId                                               | long   |                                  |
| 策略集实例code | strategySetInstanceCode                                      | string |                                  |
| 策略集实例id   | strategySetInstanceId                                        | long   |                                  |
| 执行模式       | mode                                                         | int    |                                  |
| 分流比例       | scale                                                        | int    |                                  |
| 策略集id       | strategySetId                                                | long   |                                  |
| 策略集名称     | strategySetName                                              | string |                                  |
| 策略上下文id   | strategyContextId                                            | string | 非并行模式时与流程上下文保持一致 |
| 策略列表       | strategys                                                    | string | 策略集关联的策略ID列表,逗号分隔  |
| 规则id         | nodeId                                                       | long   | 触发当前策略集的规则id           |

### **2、规则与特征**

#### **2.1 特征日志结构与hbase的存储结构**

| 属性名称             | 属性         | 类型    | 备注                                                    |
| -------------------- | ------------ | ------- | ------------------------------------------------------- |
| 环境                 | evn          | string  | 标识当前数据来自与哪个数据                              |
| ID/rowKey            | rowKey       | string  | 本条记录的唯一ID                                        |
| 数据类别             | category     | string  | 数据类别,参见数据类别枚举                               |
| 创建时间             | createTime   | long    |                                                         |
| 上下文Id             | contextId    | string  | 请求标识ID                                              |
| 特征集ID             | featureSetId | long    |                                                         |
| 规则ID               | nodeId       | long    |                                                         |
| 特征名称             | featureName  | string  |                                                         |
| 特征类型             | type         | string  | 标记特征是java实现还是其他脚本实现                      |
| 特征编码             | featureCode  | string  | 不同的特征,featureCode不一样,特征结果的json结构也不一样 |
| 特征ID               | featureId    | long    |                                                         |
| 特征代码是否执行成功 | result       | boolean |                                                         |
| 特征结果             | data         | string  | json形式,不同的特征,该属性是不一样的,                   |

hbase内的存储结构,作为数仓的备份同时提供内部数据服务

|           | column   |          |          |          |
| --------- | -------- | -------- | -------- | -------- |
| rowkey    | 特征code | 特征code | 特征code | 特征code |
| contextId | json     | json     | json     | json     |



1、所有特征使用json存储,不做打平处理

2、充分利用hbase的宽列特性,对于同一行数据相同column数据覆盖,不同column数据追加

![](/images/sb/cbb33031-c802-460f-9936-8bd8c4f79720.jpeg)

实际在操作上不依赖column得顺序,经过多次put后最终的存储结构如下图.

![](/images/sb/2edad887-f425-4223-957b-b5d9e0ff52c7.jpeg)

hbase松散的文档结构在存储上提供了上述的便捷性,在读取时也有很高的灵活性,任意指定列簇与列同时,另外的好处就是降低检索的数据量

3、特征数据的推送有两种方式

- 分别记录,当特征集执行完成后推送至store,优势是特征、规则等元信息齐全(默认使用此种方式)
- 整体记录,流程结束后从上下文中遍历所有的特征,优势是所有特征一次性读取批量推送



#### **2.2 规则日志与索引**(rowkey:contextId+nodeId)

| rowKey               | contextId+nodeId    |        |                            |
| -------------------- | ------------------- | ------ | -------------------------- |
| 环境                 | evn                 | string | 标识当前数据来自与哪个数据 |
| ID/rowKey            | rowKey              | string | 本条记录的唯一ID           |
| 数据类别             | category            | string | 数据类别,参见数据类别枚举  |
| 创建时间             | createTime          | long   |                            |
| 上下文Id             | contextId           | string | 请求标识ID                 |
| 规则名称             | nodeName            | string |                            |
| 规则id               | nodeId              | long   |                            |
| 流程实例Id           | flowInstanceId      | long   |                            |
| 流程id               | flowId              | long   |                            |
| 规则执行成功是否退出 | interrupt           | int    |                            |
| 特征集ID             | featureSetId        | long   |                            |
| 特征集名称           | featureSetName      | string |                            |
| 特征列表             | featureList         | string | 特征集id列表,逗号分隔      |
| 特征运行模式         | mode                | int    |                            |
| 策略集实例code       | strategySetInstCode | string |                            |

### **3、策略与动作**

#### **3.1 策略日志与索引**

| rowKey                 | trategyContextId+nodeId+strategySetInstanceId+strategySetId+strategyId |         |                                           |
| ---------------------- | ------------------------------------------------------------ | ------- | ----------------------------------------- |
| 数据类别               | category                                                     | string  | 数据类别,参见数据类别枚举                 |
| 创建时间               | createTime                                                   | long    |                                           |
| 上下文Id               | contextId                                                    | string  | 请求标识ID                                |
| 流程ID                 | flowId                                                       | long    |                                           |
| 流程实例ID             | flowInstanceId                                               | long    |                                           |
| 规则ID                 | nodeId                                                       | long    | 触发当前策略的规则ID                      |
| 策略上下文ID           | strategyContextId                                            | string  | 策略上下文ID,默认情况下与流程上下文id相同 |
| 策略集实例ID           | strategySetInstanceId                                        | long    | 绑定当前策略的策略集实例                  |
| 策略集code             | strategySetCode                                              | string  |                                           |
| 策略集ID               | strategySetId                                                | long    |                                           |
| 策略ID                 | strategyId                                                   | long    |                                           |
| 策略名称               | strategyName                                                 | string  |                                           |
| 策略表达式             | expression                                                   | string  |                                           |
| 策略执行结果           | result                                                       | boolean |                                           |
| 策略执行成功后是否退出 | interrupt                                                    | int     |                                           |
| 策略优先级             | priority                                                     | int     |                                           |
| 动作执行模式           | mode                                                         | int     |                                           |
| 动作列表               | actions                                                      | string  | 策略绑定的动作ID列表,逗号分隔             |
| 策略应用场景           | scenes                                                       | string  |                                           |



#### **3.2 动作日志与索引**

| rowKey                 | strategyContextId+nodeId+strategySetInstanceId+strategySetId+strategyId+actionId |         |                                      |
| ---------------------- | ------------------------------------------------------------ | ------- | ------------------------------------ |
| 属性名称               | 属性                                                         | 类型    | 备注                                 |
| 环境                   | evn                                                          | string  | 标识当前数据来自与哪个数据           |
| ID/rowKey              | rowKey                                                       | string  | 本条记录的唯一ID                     |
| 数据类别               | category                                                     | string  | 数据类别,参见数据类别枚举            |
| 创建时间               | createTime                                                   | long    |                                      |
| 上下文Id               | contextId                                                    | string  | 请求标识ID                           |
| 流程ID                 | flowId                                                       | long    |                                      |
| 流程实例ID             | flowInstanceId                                               | long    |                                      |
| 规则ID                 | nodeId                                                       | long    | 触发当前策略的规则ID                 |
| 策略上下文ID           | strategyContextId                                            | string  |                                      |
| 策略集实例ID           | strategySetInstanceId                                        | long    |                                      |
| 策略集ID               | strategySetId                                                | long    |                                      |
| 策略ID                 | strategyId                                                   | long    |                                      |
| 动作名称               | actionName                                                   | string  |                                      |
| 动作ID                 | actionId                                                     | long    |                                      |
| 动作优先级             | priority                                                     | int     |                                      |
| 动作执行成功后是否退出 | interrupt                                                    | int     |                                      |
| 动作执行状态           | result                                                       | boolean |                                      |
| 动作应用场景           | scenes                                                       | string  |                                      |
| 动作输出结果           | output                                                       | string  | json串,不同动作,输出结果和结构有差异 |

# **四、日志评估**

申请单独的数据库,并且只保留7日或更短的时间,临时使用现有的审核库并增加过期删除任务

### **1、日志量(7400w)**

- 流程实例日志 29w(11.5w+17.1) +  (10W+16.7W) ,流程日志  60w
- 特征日志,每个流程,超过30个规则,30*(禁发+入审),无索引只推数仓 1800w
- 规则日志 ,同上 1800w
- 策略集实例,每个规则绑定一个策略集实例,同上 1800w
- 策略日志,策略集存在多个策略,2*策略日志 3600w
- 动作日志,策略绑定多个动作,2*流程实例日志 120w

### **2、 离线日志(无中断,无动作)**

离线日志只推数仓和hbase

# **五、其他**

- 基于索引表对外接口,用户id,帖子/评论id,上下文id查询执行过程
- 关联审核后台与规则引擎,增加关联表(不适合审核区拆分)或content_audit,operation_log追加contextId
- 根据实际情况增删字段,并且提前通知数仓(不便于增加字段)
- 接口验证 与各式文档

 [索引与日志数据检查接口.xlsx](/images/sb/索引与日志数据检查接口.xlsx) 

 [规则引擎日志格式-20220511.xlsx](/images/sb/规则引擎日志格式-20220511.xlsx) 



