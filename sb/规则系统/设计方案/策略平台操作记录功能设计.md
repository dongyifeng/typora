策略平台操作记录功能设计

# 一、背景

业务方在策略平台上的修改，会对规则引擎的运行产生影响。

对操作记录存档，既方便业务方、研发排查问题，又能对策略的变更保留历史记录。

# 二、表结构设计

```SQL
CREATE TABLE `rule_engine_module_operation_log` (

  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',

  `module_type` tinyint(2) NOT NULL COMMENT '组件类型 RuleEngineModuleType',

  `module_id` bigint(20) NOT NULL COMMENT '组件id',

  `operation_name` varchar(256) NOT NULL COMMENT '操作名称',

  `operate_detail` varchar(1024) NOT NULL DEFAULT '' COMMENT '操作详情',

  `remark` varchar(256) NOT NULL DEFAULT '' COMMENT '备注',

  `operator_uid` bigint(20) NOT NULL COMMENT '操作人uid',

  `created_at` bigint(20) NOT NULL COMMENT '创建时间',

  PRIMARY KEY (`id`),

  KEY `idx_module_type_module_id` (`module_type`,`module_id`)

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='规则引擎模块操作记录';
```



# 三、方案设计



- 通过AOP加注解实现。
- 将具有简单写逻辑的接口分为三类，
  - 1、组件状态的更新，如启用、停用等；
  - 2、组件的一个或多个字段修改，如更新动作归属的场景；
  - 3、新增，如保存规则节点。
- 复杂写逻辑的操作记录还需跟随业务代码编写。



1. 定义注解

```Java
@Target({ElementType.METHOD})

@Retention(RetentionPolicy.RUNTIME)

@Documented

public @interface OperationLog {



    OperateType operateType() default OperateType.UNKNOWN;



    RuleEngineModuleType knowledgeBaseModule() default RuleEngineModuleType.UNKNOWN;



    /**

     * 当操作类型是 OperateType.EDIT 时，需要声明被修改组件的id，即请求中定义的id字段名

     * eg. FeatureSetModel的featureSetId

     */

    String primaryKey() default "";

}
```





1. 定义切面

方法执行后，根据请求的响应结果，决定是否写操作记录。

```Java
@Aspect

@Component

@Slf4j

public class OperationLogAspect {



    @Around("@annotation(com.xueqiu.snowflake.core.annotation.OperationLog)")

    public Object aroundAdvice(ProceedingJoinPoint pjp) throws Throwable {

        ApiModelResult result = (ApiModelResult) pjp.proceed();



        //成功-记录日志

        if (result.getCode() == HttpRequestErrorCode.SYSTEM_SUCCESS.getErrorCode()) {

            try {

                recordOperationLogExecutor.submit(() -> recordOperationLog(pjp, result));

            } catch (Exception e) {

                log.error("recordOperationLog error", e);

            }

        }

        return result;

    }

 }
```



1. 上线前，对所有生效中的组件，分别插入一条新增类型的操作记录。